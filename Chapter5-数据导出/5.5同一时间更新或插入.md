<h2>5.5同一时间更新或插入</h2>


<h3>问题</h3>
数据库中有数据来自以前的导出,但现在需要从Hadoop更新后并希望和数据库同步。不幸的是,不能使用更新模式, 因为有大量的新行, 并且还需要导出它们。

<h3>解决方案</h3>
如果在同一作业中需要更新和插入,则可以使用更新模式allowinsert参数激活所谓的upsert模式。例如:

```
sqoop export \
--connect jdbc:mysql://mysql.example.com/sqoop \
--username sqoop \
--password sqoop \
--table cities \
--update-key id \
--update-mode allowinsert
```

<h3>讨论</h3>

有条件地插入新行时或更新现有行的能力是称为upsert的高级数据库功能。此功能在所有数据库系统上不可用, 也不支持所有Sqoop连接器。
目前, 它只适用于Oracle和nondirect MySQL的导出。
每个数据库都以不同的方式实现upsert功能。使用 Oracle, Sqoop 使用一个合并语句来指定用于区分插入或更新操作是否应执行的整个条件。
使用 MySQL, Sqoop使用不接受任何用户指定条件的重复密钥更新子句。它决定是根据表的唯一键更新还是插入。
upsert功能将永远不会删除任何行: 如果试图同步数据库中的数据, 并使用 Hadoop 中的任意更改的数据, 则此更新方法将无法正常工作。
如果需要执行完全同步(包括插入、更新和删除), 则应使用正常导出导出整个数据集, 而不启用任何更新功能。
当然, 这需要一个空的输出表, 所以必须先截断它, 然后再正在运行导出。如果不能这样做, 因为应用程序正积极使用表, 可以暂时将数据导出到其他表, 
然后交换两个表在sqoop导出成功后。